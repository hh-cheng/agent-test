## Gemini 审计要求（Code + Product + System）

### 0. 审计目标

本次审计不仅检查代码质量与缺陷，还要验证：

1. PR 是否完整实现对应的产品需求（PRD / User Story / Issue）
2. 是否存在功能缺失、边界场景遗漏、系统级 bug 或可用性缺陷
3. 是否引入安全、性能、稳定性、兼容性风险
4. 是否具备可验证的交付标准（测试、监控、回滚/降级策略）

---

### 1. 输入信息（Gemini 审计必须基于这些上下文）

* PR 标题、描述、关联 Issue/PRD 链接、验收标准（如有）
* 本 PR 的变更范围：主要模块、关键接口、数据模型、前后端交互
* 关键用户路径（happy path）与至少 5 个边界场景（见第 3 节）
* 运行门禁：lint/test/typecheck/build、e2e（如有）

若 PR 缺少上述信息，Gemini 必须在审计结论中标记为 **“审计信息不足（Needs Context）”** 并列出缺失项。

---

### 2. 产品实现完整性审计（必须做）

Gemini 需要对照 PRD/Issue 的功能点逐项核对，输出：

* **已覆盖功能**：实现点与对应代码/文件位置
* **疑似缺失功能**：未看到实现或实现不完整的点（明确说明缺失原因与影响）
* **行为偏差**：实现逻辑与需求描述不一致之处（指出预期 vs 实际）

最低要求：

* 覆盖所有 “Must-have” 功能点
* “Should-have” 若未实现，必须在 PR 中显式声明并获得同意

---

### 3. 系统级缺陷审计（必须做）

Gemini 必须从“端到端系统”的角度检查潜在缺陷，而非仅局部代码。

#### 3.1 用户体验与流程完整性

* 关键用户路径是否闭环（从入口到成功/失败反馈）
* 异常状态是否可见且可恢复（错误提示、重试、引导）
* 权限不足/未登录/无数据/超时等状态是否覆盖

#### 3.2 数据一致性与幂等

* 是否存在重复提交、并发写入导致的数据不一致
* 是否需要幂等键/去重逻辑/乐观锁
* 是否存在部分成功导致的“半完成状态”

#### 3.3 接口契约与兼容性

* 前后端接口字段是否一致（类型、可空性、枚举范围）
* 是否引入 breaking change（API/schema/DB migration）
* 是否正确处理版本兼容与回滚

#### 3.4 安全与权限模型（最小集合）

* 鉴权/鉴权绕过风险（仅前端校验不算）
* 输入校验、注入风险、敏感信息泄露（日志/响应）
* 访问控制是否符合产品角色与权限要求

#### 3.5 性能与稳定性

* N+1 查询、分页缺失、大对象传输、重复请求
* 缓存策略是否合理（如有），是否存在缓存污染/不一致
* 超时、重试、熔断/降级策略是否需要（至少指出风险）

#### 3.6 可观测性与运维风险

* 关键行为是否有日志/埋点（至少错误与关键路径）
* 失败场景是否可定位（错误码/trace id/结构化日志）
* 配置项是否明确（env 变量、feature flag）

---

### 4. 代码层面审计（仍然需要）

* 逻辑正确性、边界处理、错误处理
* 可读性与可维护性（重复逻辑、模块边界）
* 规范：lint、类型、格式、依赖安全
* 测试：单元/集成/e2e 覆盖关键路径与边界

---

### 5. 输出格式要求（必须结构化，便于 Codex 执行）

Gemini 的输出必须包含以下区块，且每个问题都要可执行、可验证：

#### 5.0 @codex 触发规则（必须）

* 若审计结论需要修改代码（存在 Blocker/Major/Minor/Suggestion 中任意需要代码改动的项），评论正文第一行必须添加 `@codex`
* 若无需修改代码（仅结论/说明/确认无问题），评论正文第一行不得包含 `@codex`

#### 5.1 总结

* PR 意图概述（1-3 句）
* 风险评级：Low / Medium / High
* 是否可合并：Yes / No（若 No，列出阻断项数量）

#### 5.2 需求覆盖矩阵（Product Coverage Matrix）

以 checklist 或表述形式输出：

* [ ] 功能点 A：已实现 / 部分实现 / 未实现（附代码位置或证据）
* [ ] 功能点 B：…

#### 5.3 问题清单（分级）

每条 issue 必须包含：

* Severity：Blocker / Major / Minor / Suggestion
* Category：Product Gap / System Bug / Security / Performance / Code Quality / Test / DX
* Location：文件与大致范围（如可）
* Problem：问题描述
* Fix：明确修复建议
* Acceptance Criteria：可验证标准（测试/行为/日志/接口契约）

#### 5.4 建议的回归测试清单

* 必跑命令（lint/test/build/typecheck）
* 建议增加的用例（至少覆盖关键路径 + 边界场景）

---

### 6. 协作约束（避免“审计漂移”）

* 不要求与需求无关的大规模重构
* 不引入新的依赖，除非必要且说明理由
* 若发现需求不明确，必须提出“需要产品/作者澄清的问题清单”

---

### 7. 结束条件（DoD）

当且仅当满足：

* 所有 Blocker 关闭
* Product Coverage Matrix 中 Must-have 全部为 “已实现”
* 门禁命令全通过
* 回归清单覆盖关键路径与主要边界场景
  即可认为审计通过。
