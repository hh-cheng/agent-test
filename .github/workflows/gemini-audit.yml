name: Gemini Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - '**' # è§¦å‘æ‰€æœ‰åˆ†æ”¯çš„ PR å®¡è®¡

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿å¯¹æ¯” diff

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          corepack enable
          pnpm install --no-frozen-lockfile

      - name: Prepare PR diff
        run: |
          # è·å– base åˆ†æ”¯å¹¶ç”Ÿæˆ diff æ–‡ä»¶
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git diff origin/${{ github.event.pull_request.base.ref }}...${{ github.sha }} > pr.diff

      - name: Install Gemini CLI
        run: |
          npm install -g @google/gemini-cli

      - name: Run Gemini Audit
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        run: |
          # 1. æ„é€  Promptï¼šåˆå¹¶å®¡è®¡è§„åˆ™å’Œä»£ç å·®å¼‚
          echo "ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„ Next.js å¼€å‘è€…å’Œå®‰å…¨ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å®¡è®¡è§„åˆ™å¯¹ä»£ç å·®å¼‚è¿›è¡Œè¯„å®¡ã€‚" > prompt.txt
          echo "### å®¡è®¡è§„åˆ™ï¼š" >> prompt.txt
          cat .github/ai-review-rubric.md >> prompt.txt
          echo -e "\n### ä»£ç å·®å¼‚ (Diff)ï¼š" >> prompt.txt
          cat pr.diff >> prompt.txt
          
          # 2. è°ƒç”¨ Gemini CLI
          # -y: è‡ªåŠ¨æ¥å—æ‰€æœ‰æ“ä½œï¼Œä¸è¿›å…¥äº¤äº’æ¨¡å¼
          # æˆ‘ä»¬é€šè¿‡ç®¡é“å°† prompt.txt çš„å†…å®¹ä¼ ç»™ gemini
          cat prompt.txt | gemini -y > gemini_audit_report.txt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Post audit results as comment
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            if (fs.existsSync("gemini_audit_report.txt")) {
              const body = fs.readFileSync("gemini_audit_report.txt", "utf8");
              if (body.trim()) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: "### ğŸ¤– Gemini ä»£ç å®¡è®¡æŠ¥å‘Š\n\n" + body,
                });
              }
            }