name: Codex Auto PR

on:
  push:
    branches:
      - "codex/*"
      - "codex/**"

jobs:
  create_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Create PR if missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}
          script: |
            const base = context.payload.repository.default_branch;
            const head = context.ref.replace("refs/heads/", "");
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${head}`,
              base,
              state: "open",
            });

            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Codex: ${head}`;
            const body = `Auto-created PR for branch \`${head}\`.`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head,
              base,
              title,
              body,
            });

            core.info(`Created PR: ${pr.html_url}`);
