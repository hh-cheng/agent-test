name: Codex Auto PR

on:
  workflow_run:
    workflows: ["Codex Task Runner"]
    types: [completed]

jobs:
  create_pr:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'codex/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Create PR if missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_CREATOR_TOKEN }}
          script: |
            const base = context.payload.repository.default_branch;
            const head = context.payload.workflow_run.head_branch;

            if (!head) {
              core.info("No head branch found for workflow_run event.");
              return;
            }
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${head}`,
              base,
              state: "open",
            });

            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Codex: ${head}`;
            const body = `Auto-created PR for branch \`${head}\`.`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head,
              base,
              title,
              body,
            });

            core.info(`Created PR: ${pr.html_url}`);
